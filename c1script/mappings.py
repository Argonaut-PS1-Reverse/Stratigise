"""
Functions/commands signatures, insn mappings, etc.
"""

class Signature:
    def __init__(self, name, insn, signature):
        self.name = name
        self.insn = insn
        self.signature = signature
        
    def __format__(self, _unused):
        return f"{self.name}({', '.join(self.signature)})"
    
MAGIC_VALUE = 65536
        
COMMAND_SIGNATURES = [
	Signature("turnTowardX", "TurnTowardX", ["int16", "eval"]),
	Signature("turnTowardY", "TurnTowardY", ["int16", "eval"]),
	Signature("turnTowardWaypointX", "TurnTowardWaypointX", ["eval"]),
	Signature("playSound", "PlaySound", ["int8", "eval", "varargs"]),
	Signature("stopSound", "StopSound", ["eval"]),
	Signature("playAnim", "PlayAnim", ["eval"]),
	Signature("stopAnim", "StopAnim", []),
	Signature("waitAnimend", "WaitAnimend", []),
	Signature("print", "Print", ["string"]),
	Signature("specialFXOn", "SpecialFXOn", ["eval"]),
	Signature("wait", "Wait", ["eval"]),
	Signature("resetPosition", "ResetPosition", []),
	Signature("scaleX", "ScaleX", ["eval"]),
	Signature("scaleY", "ScaleY", ["eval"]),
	Signature("scaleZ", "ScaleZ", ["eval"]),
	Signature("jump", "Jump", ["eval"]),
	Signature("fall", "Fall", []),
	Signature("moveBackward", "MoveBackward", ["eval"]),
	Signature("moveForward", "MoveForward", ["eval"]),
	Signature("moveRight", "MoveRight", ["eval"]),
	Signature("moveDown", "MoveDown", ["eval"]),
	Signature("moveLeft", "MoveLeft", ["eval"]),
	Signature("moveUp", "MoveUp", ["eval"]),
	Signature("turnRight", "TurnRight", ["eval"]),
	Signature("turnLeft", "TurnLeft", ["eval"]),
	Signature("tiltBackward", "TiltBackward", ["eval"]),
	Signature("tiltForward", "TiltForward", ["eval"]),
	Signature("tiltRight", "TiltRight", ["eval"]),
	Signature("tiltLeft", "TiltLeft", ["eval"]),
	Signature("spawn", "Spawn", ["int8", "string", "varargs"]),
	Signature("createTrigger", "CreateTrigger", ["int8", "varargs", "trigger"]),
	Signature("killTrigger", "KillTrigger", ["int16"]),
	Signature("letGVar", "LetGVar", ["int16", "eval"]),
    Signature("remove", "Remove", []),
	Signature("letPGVar", "LetPGVar", ["int16", "eval"]),
	Signature("letAVar", "LetAVar", ["int16", "eval"]),
	Signature("setModel", "SetModel", ["eval"]),
	Signature("blink", "Blink", ["int8", "varargs_int"]),
	Signature("holdTrigger", "HoldTrigger", []),
	Signature("releaseTrigger", "ReleaseTrigger", []),
	Signature("setAnim", "SetAnim", ["eval"]),
	Signature("turnTowardXY", "TurnTowardXY", ["int16", "eval", "eval"]),
	Signature("hold", "Hold", []),
	Signature("release", "Release", ["string"]),
	Signature("playerAttackOn", "PlayerAttackOn", []),
	Signature("playerAttackOff", "PlayerAttackOff", []),
	Signature("camWobble", "CamWobble", ["eval"]),
	Signature("lookAtMe_0", "LookAtMe_0", []),
	Signature("shadowSize", "ShadowSize", ["eval"]),
	Signature("shadowType", "ShadowType", ["int8"]),
	Signature("clearAnim", "ClearAnim", []),
	Signature("stopFall", "StopFall", []),
	Signature("setPlayerPosRel", "SetPlayerPosRel", ["eval", "eval", "eval"]),
	Signature("collectKey", "CollectKey", []),
	Signature("removeKey", "RemoveKey", []),
	Signature("collisionOn", "CollisionOn", ["eval"]),
	Signature("collisionOff", "CollisionOff", ["eval"]),
	Signature("pauseTriggers", "PauseTriggers", []),
	Signature("unpauseTriggers", "UnpauseTriggers", []),
	Signature("setPosition", "SetPosition", []),
	Signature("isPlayer", "IsPlayer", []),
	Signature("scale", "Scale", ["eval"]),
	Signature("turnTowardWaypointY", "TurnTowardWaypointY", ["eval"]),
	Signature("hide", "Hide", []),
	Signature("unhide", "Unhide", []),
	Signature("letXGVar", "LetXGVar", ["int16", "eval"]),
	Signature("setCamHeight", "SetCamHeight", ["eval"]),
	Signature("setLevel", "SetLevel", ["eval", "eval"]),
	Signature("shadowOn", "ShadowOn", []),
	Signature("shadowOff", "ShadowOff", []),
	Signature("accelerate", "Accelerate", []),
	Signature("decelerate", "Decelerate", []),
	Signature("setAnimSpeed", "SetAnimSpeed", ["eval"]),
	Signature("setCamDist", "SetCamDist", ["eval"]),
	Signature("userTrigger", "UserTrigger", ["int16", "eval"]),
	Signature("waitEvent", "WaitEvent", ["int8"]),
	Signature("playerCollisionOn", "PlayerCollisionOn", []),
	Signature("animCtrlSpdOn", "AnimCtrlSpdOn", []),
	Signature("animCtrlSpdOff", "AnimCtrlSpdOff", []),
	Signature("letParam", "LetParam", ["int16", "eval"]),
	Signature("turnTowardPosX", "TurnTowardPosX", ["eval", "eval", "eval", "eval"]),
	Signature("specialFXOff", "SpecialFXOff", ["eval"]),
	Signature("openEyes", "OpenEyes", []),
	Signature("closeEyes", "CloseEyes", ["int8", "varargs_int"]),
	Signature("jumpCtrlOn", "JumpCtrlOn", []),
	Signature("jumpCtrlOff", "JumpCtrlOff", []),
	Signature("stomp", "Stomp", []),
	Signature("pushCamera", "PushCamera", []),
	Signature("pullCamera", "PullCamera", []),
	Signature("float", "Float", []),
	Signature("spawnChild", "SpawnChild", ["int8", "string", "varargs"]), # Warning: Variable arguments, cannot yet properly disassemble
	Signature("setCamera", "SetCamera", ["eval"]),
	Signature("addPickup", "AddPickup", ["eval"]),
	Signature("losePickups", "LosePickups", []),
	Signature("reverse", "Reverse", []),
	Signature("playerCollisionOff", "PlayerCollisionOff", []),
	Signature("setCollPoint", "SetCollPoint", ["eval", "eval", "eval", "eval"]),
	Signature("setCollPoints", "SetCollPoints", ["eval"]),
	Signature("pushingOn", "PushingOn", []),
	Signature("pushingOff", "PushingOff", []),
	Signature("pushableOn", "PushableOn", []),
	Signature("pushableOff", "PushableOff", []),
	Signature("pushWaypoint", "PushWaypoint", []),
	Signature("pullWaypoint", "PullWaypoint", []),
	Signature("nextWaypoint", "NextWaypoint", []),
	Signature("prevWaypoint", "PrevWaypoint", []),
	Signature("turnTowardWaypointXY", "TurnTowardWaypointXY", ["eval", "eval"]),
	Signature("turnTowardPosXY", "TurnTowardPosXY", ["eval", "eval", "eval", "eval", "eval"]),
	Signature("nearestWaypointNext", "NearestWaypointNext", []),
	Signature("nearestWaypointPrev", "NearestWaypointPrev", []),
	Signature("deleteWaypoint", "DeleteWaypoint", []),
	Signature("moveForwardAngle", "MoveForwardAngle", ["eval", "eval"]),
	Signature("turnTowardPosY", "TurnTowardPosY", ["eval", "eval", "eval", "eval"]),
	Signature("movePlayerForward", "MovePlayerForward", ["eval"]),
	Signature("movePlayerBackward", "MovePlayerBackward", ["eval"]),
	Signature("loopSound", "LoopSound", ["eval", "eval"]),
	Signature("wobble", "Wobble", ["int8", "int16"]),
	Signature("camHold", "CamHold", ["eval"]),
	Signature("speedUp", "SpeedUp", ["eval"]),
	Signature("slowDown", "SlowDown", ["eval"]),
	Signature("smoothSpeed", "SmoothSpeed", ["eval"]),
	Signature("accelerateAngle", "AccelerateAngle", ["eval"]),
	Signature("decelerateAngle", "DecelerateAngle", ["eval"]),
	Signature("movePosition", "MovePosition", ["int16", "int16", "int16", "eval", "eval"]),
	Signature("removeFromMap", "RemoveFromMap", []),
	Signature("initCrystal", "InitCrystal", []),
	Signature("crystal", "Crystal", []),
	Signature("endLevel", "EndLevel", []),
	Signature("stopDead", "StopDead", []),
	Signature("pitchShift", "PitchShift", ["eval", "eval"]),
	Signature("activated", "Activated", []),
	Signature("hangOn", "HangOn", []),
	Signature("hangOff", "HangOff", []),
	Signature("createDeath", "CreateDeath", []),
	Signature("doDeath", "DoDeath", []),
	Signature("endCrystal", "EndCrystal", []),
	Signature("pausePlayer", "PausePlayer", []),
	Signature("unpausePlayer", "UnpausePlayer", []),
	Signature("playerDead", "PlayerDead", []),
	Signature("slideOn", "SlideOn", []),
	Signature("slideOff", "SlideOff", []),
	Signature("firstWaypoint", "FirstWaypoint", []),
	Signature("collected", "Collected", []),
	Signature("spawnFrom", "SpawnFrom", ["int8", "string", "varargs"]), # Warning: Variable arguments, cannot yet properly disassemble
	Signature("letXParam", "LetXParam", ["int16", "eval"]),
	Signature("removeCrystal", "RemoveCrystal", []),
	Signature("collectJigsaw", "CollectJigsaw", ["eval"]),
	Signature("bonus", "Bonus", ["int32"]),
	Signature("nextLevel", "NextLevel", []),
	Signature("lookAtMe_1", "LookAtMe_1", []),
	Signature("noHang", "NoHang", []),
	Signature("vibrate", "Vibrate", ["eval"]),
	Signature("playerNoStood", "PlayerNoStood", []),
	Signature("removeGobbo", "RemoveGobbo", []),
	Signature("pauseTriggersNoAnim", "PauseTriggersNoAnim", []),
	Signature("showBonus", "ShowBonus", []),
	Signature("lookAtMeMap", "LookAtMeMap", []),
	Signature("playerMove", "PlayerMove", []),
	Signature("playerTurn", "PlayerTurn", []),
	Signature("setEnvelope", "SetEnvelope", ["eval", "eval", "eval", "eval", "eval", "eval"]),
	Signature("turnTowardPlayerX", "TurnTowardPlayerX", ["eval"]),
	Signature("turnTowardPlayerY", "TurnTowardPlayerY", ["eval"]),
	Signature("turnTowardPlayerXY", "TurnTowardPlayerXY", ["eval", "eval"]),
	Signature("forceDoor", "ForceDoor", ["eval"]),
	Signature("levelStats", "LevelStats", []),
	Signature("reSeed", "ReSeed", []),
	Signature("showBonusOn", "ShowBonusOn", []),
	Signature("showBonusOff", "ShowBonusOff", []),
	Signature("removeModel", "RemoveModel", []),
	Signature("quickPlayer", "QuickPlayer", []),
	Signature("gobboON", "GobboON", []),
	Signature("gobboOFF", "GobboOFF", []),
	Signature("unActivated", "UnActivated", []),
	Signature("endSubLevel", "EndSubLevel", []),
	Signature("turnOffLookAtMe", "TurnOffLookAtMe", []),
	Signature("heightFloat", "HeightFloat", []),
	Signature("flashOn", "FlashOn", []),
	Signature("flashOff", "FlashOff", []),
	Signature("lightRadius", "LightRadius", ["eval"]),
	Signature("lightPower", "LightPower", ["eval"]),
	Signature("lightColor", "LightColor", ["eval", "eval", "eval"]),
	Signature("commandError", "CommandError", []),
	Signature("command0xfd", "Command0xfd", []),
	Signature("tonyTest", "TonyTest", []),
	Signature("lewisTest", "LewisTest", ["int8", "eval"]),
]
COMMAND_MAP = {sign.name: sign for sign in COMMAND_SIGNATURES}

FUNCTION_SIGNATURES = [
    Signature("loadObject", "LoadObject", ["string"]),
    Signature("loadAsset0", "LoadAsset0", ["string"]),
    Signature("loadAsset1", "LoadAsset1", ["string"]),
    Signature("loadAsset2", "LoadAsset2", ["string"]),
    Signature("loadAsset3", "LoadAsset3", ["string"]),
    Signature("loadAsset4", "LoadAsset4", []),
    Signature("loadAsset5", "LoadAsset5", []),
    Signature("loadAnim", "LoadAnim", ["string"]),
    Signature("loadSound", "LoadSound", ["int8", "varargs"]),

    Signature("sin", "Sine", ["stack"]),
    Signature("cos", "Cosine", ["stack"]),
	Signature("sqrt", "SquareRoot", ["stack"]),
	Signature("abs", "AbsoluteValue", ["stack"]),
    Signature("random", "RandomNumber", ["stack"]),
    Signature("floor", "FloorNumber", ["stack"]),
    
	Signature("distanceFromPoint", "DistanceFromPoint", ["stack", "stack", "stack"]),
    Signature("checkAnimFlag32", "CheckAnimFlag32", ["stack", "stack"]),
]
FUNCTION_MAP = {sign.name: sign for sign in FUNCTION_SIGNATURES}

BINARY_OPERATOR_MAP = {
    "and": "TopPairNotZero",
    "or": "BitOr",
    "&": "BitAnd",
    "|": "BitOr",
    ">": "TopLess",
    "<": "TopGreater",
    ">=": "TopNotGreater",
    "<=": "TopNotLess",
    "==": "Equal",
    "!=": "NotEqual",
    "+": "Add",
	"-": "Subtract",
    "*": "Multiply",
    "/": "Divide",
    ">>": "BitShiftRight",
    "<<": "BitShiftLeft"
}

UNARY_OPERATOR_MAP = {
    "!": "IsZero",
    "+": None,
    "-": "Negate"
}

VAR_MAP = {
    "vars": {"let": "LetGVar", "push": "PushGVar", "limit": 192, "kind_int": 2, "name_pfx": "g_var"},
    "pg_vars": {"let": "LetPGVar", "push": "PushPGVar", "limit": 192, "kind_int": 1, "name_pfx": "pg_var"},
    "alien_vars": {"let": "LetAVar", "push": "PushAVar", "limit": 128, "kind_int": None, "name_pfx": "a_var"}, # not sure about limit
    "params": {"let": "LetParam", "push": "PushStratVar", "limit": 8, "kind_int": 29, "name_pfx": "param"},
    "xg_vars": {"let": "LetXGVar", "push": "PushExternGlobal", "limit": 74, "kind_int": 28, "name_pfx": "xg_var"},
    "x_params": {"let": "LetXParam", "push": "PushXParam", "limit": 8, "kind_int": 45, "name_pfx": "x_param"}
}
VAR_SETTERS = [v["let"] for v in VAR_MAP.values()]
VAR_GETTERS = [v["push"] for v in VAR_MAP.values()]

VAR_SIZES = [
    {"index": 0, "name": "S", "size": 0},
    {"index": 1, "name": "M", "size": 4},
    {"index": 2, "name": "L", "size": 8},
    {"index": 3, "name": "XL", "size": 16},
    {"index": 4, "name": "XXL", "size": 32},
    {"index": 5, "name": "XXXL", "size": 64},
    {"index": 6, "name": "SXXXL", "size": 192}
]

SPECIAL_CONDITIONS = {
    "animend": "IfAnimend",
    "jumping": "IfJumping",
    "falling": "IfFalling",
}

ALIEN_VARS = {
    0: "a_surface_height",
    1: "a_surface_type",
    2: "a_pos_x",
    3: "a_pos_y",
    4: "a_pos_z",
    5: "a_angle_x",
    6: "a_angle_y",
    7: "a_angle_z",
    12: "a_keys_held",
    13: "a_keys_pressed",
    15: "a_player_pos_x",
    16: "a_player_pos_y",
    17: "a_player_pos_z",
    18: "a_player_angle_x",
    19: "a_player_angle_y",
    20: "a_player_angle_z",
    24: "a_jumping_up",
    25: "a_jumping_down",
    28: "a_distance_to_player",
    29: "a_distance_to_waypoint",
    30: "a_waypoint_pos_x",
    31: "a_waypoint_pos_y",
    32: "a_waypoint_pos_z",
    33: "a_waypoint_index",
    34: "a_waypoint_flags",
    36: "a_player_is_staying_on",
    38: "a_camera_angle_x",
    40: "a_map_style",
    41: "a_has_crystals",
    45: "a_player_angle_y",
    46: "a_gobbos_count",
    47: "a_player_is_stomping_on",
    48: "a_is_activated",
    51: "a_spawner_pos_x",
    52: "a_spawner_pos_y",
    53: "a_spawner_pos_z",
    54: "a_spawner_angle_x",
    55: "a_spawner_angle_y",
    56: "a_spawner_angle_z",
    57: "a_has_door_key",
    58: "a_entry_door_flags",
    59: "a_player_pos_rel_x",
    60: "a_player_pos_rel_y",
    61: "a_player_pos_rel_z",
    65: "a_is_landed",
    66: "a_player_light_power",
    67: "a_all_bonus_crystals_collected",
    68: "a_cage_keys_count",
    72: "a_surface_tilt_type",
    73: "a_angle_to_slide_direction",
    78: "a_particles_on",
    83: "a_settings_lights_on",
    90: "a_invincibility_blink"
}

KEY_CONSTANTS = {
	(1 << 0): "KEY_FORWARD",
	(1 << 1): "KEY_BACKWARD",
	(1 << 2): "KEY_LEFT",
	(1 << 3): "KEY_RIGHT",
	(1 << 4): "KEY_JUMP",
	(1 << 5): "KEY_5",
	(1 << 6): "KEY_6",
	(1 << 7): "KEY_SIDE_STEP_LEFT",
	(1 << 8): "KEY_SIDE_STEP_RIGHT",
	(1 << 9): "KEY_9",
	(1 << 10): "KEY_10",
	(1 << 11): "KEY_ATTACK",
	(1 << 12): "KEY_TURN_180",
	(1 << 13): "KEY_13",
	(1 << 14): "KEY_CAMERA_DOWN",
	(1 << 15): "KEY_CAMERA_UP"
}

ALIEN_VARS_CONSTANTS = {
    "a_map_style": { # Taken from CrocUtils
        MAGIC_VALUE * 0: "MAP_STYLE_ICE",
        MAGIC_VALUE * 1: "MAP_STYLE_WATER",
        MAGIC_VALUE * 2: "MAP_STYLE_CASTLE",
        MAGIC_VALUE * 3: "MAP_STYLE_DESERT",
        MAGIC_VALUE * 4: "MAP_STYLE_CAVE",
        MAGIC_VALUE * 5: "MAP_STYLE_WOOD",
        MAGIC_VALUE * 6: "MAP_STYLE_DUNGEON",
        MAGIC_VALUE * 7: "MAP_STYLE_BOSS1",
        MAGIC_VALUE * 8: "MAP_STYLE_BOSS2",
        MAGIC_VALUE * 9: "MAP_STYLE_BOSS3",
        MAGIC_VALUE * 10: "MAP_STYLE_BOSS4",
        MAGIC_VALUE * 11: "MAP_STYLE_BOSS5",
        MAGIC_VALUE * 12: "MAP_STYLE_BOSS6",
        MAGIC_VALUE * 13: "MAP_STYLE_BOSS7",
        MAGIC_VALUE * 14: "MAP_STYLE_BOSS8",
        MAGIC_VALUE * 15: "MAP_STYLE_BOSS9",
        MAGIC_VALUE * 16: "MAP_STYLE_WHALE",
        MAGIC_VALUE * 17: "MAP_STYLE_ISLAND1",
        MAGIC_VALUE * 18: "MAP_STYLE_ISLAND2",
        MAGIC_VALUE * 19: "MAP_STYLE_ISLAND3",
        MAGIC_VALUE * 20: "MAP_STYLE_ISLAND4",
        MAGIC_VALUE * 21: "MAP_STYLE_ISLAND5",
        MAGIC_VALUE * 22: "MAP_STYLE_ICESLIDE",
        MAGIC_VALUE * 23: "MAP_STYLE_BOULDER",
        MAGIC_VALUE * 24: "MAP_STYLE_ICECAVE"
	},
    "a_keys_pressed": KEY_CONSTANTS,
    "a_keys_held": KEY_CONSTANTS
}
